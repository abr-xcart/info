<html>
<head>
<title>tools</title>
</head>
<body>

<h1>IBS</h1>
<pre>
update-ca-certificates

/etc/ssl/certs/ca-certificates.crt
set ssl:ca-file "/etc/ssl/certs/ca-certificates.crt"
</pre>

<h1>Jenkins</h1>
<pre>
/var/lib/jenkins/secrets/initialAdminPassword
</pre>

<h1>Docker</h1>
<pre>
yes | docker image prune -a
# Docker images inspect
docker images | tail -n +2 | perl -pe 's#(.*?)\s+(.*?)\s+(.*?)\s+.*#echo "\# $1:$2" > $3.json ;docker inspect $3 >> $3.json #' | sh
</pre>

<h1>Support</h1>
<pre>
dir="var log files catalog templates_c .pgp skin* images"
find $dir -exec chmod a+w "{}" \;

cd .git
chmod -R ug+rw,o-rwx .
find . -type d -exec chmod g+s "{}" \;

wget -Ophpinfo.php http://info.x-dev.us/phpinfo
wget -O`ls -1d /var/www/vhosts/*/httpdocs/`phpinfo.php http://info.x-dev.us/phpinfo

wget -O/etc/profile.d/abr.sh http://info.x-dev.us/abr.sh
wget -Oxcheck.php http://info.x-dev.us/xcheck/xcheck.php
wget -Omod_install.php http://info.x-dev.us/mod_install/mod_install.php
wget -Oftp.php http://info.x-dev.us/ftp/ftp.php
wget -Oatar.php http://info.x-dev.us/atar/atar.php

wget http://www.day32.com/MySQL/tuning-primer.sh
wget https://raw.githubusercontent.com/rackerhacker/MySQLTuner-perl/master/mysqltuner.pl

mkdir ~/.ssh 2>&1 && wget -O ~/.ssh/authorized_keys ~/.ssh/authorized_keys http://info.x-dev.us/authorized_keys 2>&1 && chmod -R go-rwx ~/.ssh

</pre>

<h1>VIM</h1>
<pre>
:set wrap
:e ++ff=unix
:%s/\r//g

:s@^--- xcart/\([^\t]\+\)\t@Index: \1\r\0@g
:,/^Index:/-1d
</pre>
<h1>SQL PARSER</h1>
<pre>
:s/\(SELECT\|FROM\|INNER JOIN\|LEFT JOIN\|GROUP BY\|WHERE\|JOIN\|ORDER BY\|HAVING\|LIMIT\) /\r\1 \r\t/gi
:s/\(SELECT\( DISTINCT\)\?\|FROM\|INNER JOIN\|LEFT JOIN\|GROUP BY\|WHERE\|JOIN\|ORDER BY\|HAVING\|LIMIT\) /\r\1 \r\t/gi
</pre>
<h1>GREP</h1>
<pre>
update-alternatives --config editor
update-alternatives --config vi

cat &lt;&lt; EOL &gt;&gt; /etc/bashrc
export EDITOR=`which vim`
export VISUAL=\$EDITOR
export LS_OPTIONS='--color=auto'
export LESS='-Rr'
alias grep="grep --color=auto"
alias vi=\$EDITOR

EOL


export EXCLUDES=$(for e in so bin exe dll cur cpp pl orig lst ico jpeg JPG jpg png tif gif iso flv wmv swf MPG mpg mp3 zip tar rar gz tgz bz2 pdf sql; do echo -n " --exclude=\*.$e "; done)
alias grep="grep --color=auto $EXCLUDES"
printf ":g/qt_debug/d\n:x\n" | ex FILE

# === grep XCart PHP files ===
pcregrep -l --color -r --exclude_dir='(?:log|upgrade|cache|tmp|templates_c)' --include='\.php$' <PATTERN> <PATH>
</pre>

<h1>GIT</h1>
<pre>
# Initialize GIT repo
git init --separate-git-dir=
git ci -m INIT --allow-empty

# system settings
git add robots.txt .user.ini php.ini .gitignore
git ci -m "system settings"

# cleanup
find . -name "*~" -print0 | xargs --no-run-if-empty -n 1 -0 git add
find . -name "*.orig" -print0 | xargs --no-run-if-empty -n 1 -0 git add
find . -name "*.ori" -print0 | xargs --no-run-if-empty -n 1 -0 git add
find . -name "*OLD" -print0 | xargs --no-run-if-empty -n 1 -0 git add
find . -name "*.bak" -print0 | xargs --no-run-if-empty -n 1 -0 git add


</pre>
<a href="https://docs.google.com/document/d/1kiHvoNl7G-O4VxjGpV2egTAb8_VQXV-q1mARJLEsFco/edit#">https://docs.google.com/document/d/1kiHvoNl7G-O4VxjGpV2egTAb8_VQXV-q1mARJLEsFco/edit#</a>
<pre>
# Setup Client Env Vars for Git
cat << EOL >> $HOME/.ssh/config
Host *
SendEnv GIT_AUTHOR_NAME
SendEnv GIT_AUTHOR_EMAIL
EOL

cat << EOL >> $HOME/.bashrc
export GIT_AUTHOR_NAME="Yuriy Abramov"
export GIT_AUTHOR_EMAIL="YAbramov@ibs.ru"
EOL

# Setup Server Env Vars for Git
echo "AcceptEnv GIT_AUTHOR_NAME GIT_AUTHOR_EMAIL" >> /etc/ssh/sshd_config
sudo sshd -t && service sshd reload

# General Git config
git config --global user.name "Yuriy Abramov"
git config --global user.email "YAbramov@ibs.ru"
git config --global color.ui true
git config --global color.status always
git config --global color.diff always
git config --global diff.tool vimdiff
git config --global difftool.prompt false
git config --global difftool.vimdiff.cmd 'vim -f -d -c "wincmd l" -c '\''cd "$GIT_PREFIX"'\'' "$LOCAL" "$REMOTE"'
git config --global mergetool.prompt false
git config --global merge.tool vimdiff
git config --global alias.d difftool
git config --global alias.co checkout
git config --global alias.ci commit
git config --global alias.b branch
git config --global alias.m mergetool
git config --global pager.branch false

git config --global core.pager 'less -R'
</pre>
<pre>
visudo
Defaults env_keep += SSH_AUTH_SOCK
</pre>
<h1>gnupg.vim</h1>
<pre>
mkdir -p $HOME/.vim/plugin
export GPG_TTY=`tty`
wget -O $HOME/.vim/plugin/gnupg.vim "http://www.vim.org/scripts/download_script.php?src_id=12200"
</pre>

https://support.cloudflare.com/hc/en-us/articles/200169166-How-do-I-whitelist-CloudFlare-s-IP-addresses-in-iptables-

service iptables-persistent save
aptitude install ipset iptables-persistent
export SET=qtm
ipset create $SET hash:net
for x in $(curl http://info.x-dev.us/qtmsoft-ips.txt); do ipset add $SET $x; done
iptables -A INPUT -m set --match-set $SET src -p tcp -m multiport --dports 1022 -j ACCEPT
service iptables-persistent save

<h1>personal demo</h1>
<pre>

начиная с 5.3.3.3 процедура удаления модуля Trial следующая
- в etc/config.php в секцию [performance] добавить ignore_system_modules = On
- сделать ребилд кеша в магазине
- на странице My addons найти модуль Trial и удалить его
</pre>
<h1>WHM FPM</h1>
<pre>
http://www.host.com:2086/scripts/command?PFILE=Service_Configuration
Service Configuration -> Apache Configuration -> Include Editor -> Pre VirtualHost Include -> All Versions -> pre_virtualhost_global.conf

https://documentation.cpanel.net/display/68Docs/Configuration+Values+of+PHP-FPM

# /scripts/php_fpm_config --rebuild
# /scripts/restartsrv_apache_php_fpm

/var/cpanel/ApachePHPFPM/system_pool_defaults.yaml

find /var/cpanel/userdata -name "*.php-fpm.yaml"


/var/cpanel/userdata/<user>/<domain.com>.php-fpm.yaml
php_admin_value_sendmail_path: {
  name: 'php_admin_value[sendmail_path]',
  value: '/usr/sbin/sendmail -t -i -fsales@domain.com'
}
request_terminate_timeout: 120
pm_max_requests: 1000
request_slowlog_timeout: 3
slowlog: "var/log/php-fpm/$pool-slow.log"

access_log: {
    name: "access.log",
    value: "var/log/php-fpm/$pool-access.log"
}


access_format: {
    name: "access.format",
    value: '"%R – %u %t \"%m %r%Q%q\" %s %f %{seconds}d %{kilo}M %C%%"'
}

find /opt/cpanel/ea-php*/root/etc/php-fpm.d/ -name "*.conf" -print -exec grep --color exec "{}" \;
find /opt/cpanel/ea-php*/root/usr/var/log/php-fpm/*slow*
find /opt/cpanel/ea-php*/root/usr/var/log/php-fpm/*access*
</pre>
<pre>

/usr/local/cpanel/scripts/install_lets_encrypt_autossl_provider

DKIM
/usr/local/cpanel/bin/dkim_keys_install system
/var/cpanel/domain_keys/public


</pre>

<h1>SQL DB</h1>
<pre>
mysql -BN -e "SHOW DATABASES" | grep -v mysql |grep -v _schema$ | xargs -n1 -I % bash -c 'echo -n "% - "; mysql -BN -e "SHOW TABLES" % | wc -l '
</pre>

<h1>APT</h1>
<pre>
apt list --upgradable |perl -pe 's#/.*##' | grep -v mysql | grep -v nginx | xargs | grep "^Listing... " | perl -pe 's#^Listing\.\.\.#apt install -y#'
</pre>

<h1>CERTBOT</h1>
<pre>
https://support.x-shops.com/wiki/doku.php?id=hosting:infrastructure_1.0:certbot
nginx -t
perl -i -pe "s#/gleniboutique.ru/#/`hostname`/#" /var/www/vhosts/system/`hostname`/conf/vhost_nginx.conf

sudo add-apt-repository -y ppa:nginx/stable
sudo add-apt-repository -y ppa:certbot/certbot
apt-get update

apt remove nginx-common nginx nginx-naxsi && apt install -y nginx
apt install -y python-certbot-nginx python3-certbot-nginx

</pre>

<h1>ICINGA</h1>
<pre>
/etc/icinga2/commands/do-req.py
cd /etc/icinga2/conf.d/
git diff
</pre>

<h1>CHEF</h1>
<pre>
/usr/bin/chef-client | tee /var/log/chef/chef.run.`date -I`
</pre>

<h1>EXIM</h1>
<pre>
Exim Configuration Manager

Require remote (hostname/IP address) HELO

Sender Verification Callouts = On
Send generic recipient failure messages = Off
Allow DKIM verification for incoming messages = On

custom_end_outgoing_smtp_checkall

accept
  hosts = *
  logwrite = "Sender rate overlimit - $sender_host_address , but whitelisted..."
  delay = 3s



Section: TRANSPORTSTART
remote_smtp_smart_dkim:
  driver = smtp
  hosts_require_tls = $host_address
  hosts_require_auth = $host_address
#  dkim_domain = $sender_address_domain
#  dkim_selector = default
#  dkim_private_key = "/var/cpanel/domain_keys/private/${dkim_domain}"
#  dkim_canon = relaxed


Section: ROUTERSTART
send_via_google:
  driver = manualroute
  domains = !+local_domains
  require_files = "+/var/cpanel/domain_keys/private/${sender_address_domain}"
#  transport = remote_smtp_smart_dkim
  transport = gmail_smtp
  route_list = $domain smtp.gmail.com::587
  senders = ^user@domain.com

Section: AUTH
manage_login:
  driver = plaintext
  public_name = PLAIN
  client_send = ^user@domain.com^pass

</pre>

<pre>
cd /opt/cdev/venvs/icinga/bin
. ./activate
rm -rf /root/.cache/pip/wheels/
if [ ! -e requirements.txt ]; then wget -q http://info.x-dev.us/requirements.txt; fi
pip install --force-reinstall --no-cache-dir -r requirements.txt
pip freeze > requirements.txt
diff <(pip freeze) requirements.txt

</pre>

<pre>
find /var/spool/goofy-agent -type f|xargs -n1 -I% bash -c " strings % |grep Subject: "
</pre>

<pre>
rm -rf var/run var/datacache/ ; while true ; do php admin.php ; done
</pre>


# cat /etc/sysconfig/docker
export HTTP_PROXY="http://USERNAME:PASSWORD@[your.proxy.server]:[port]"
export HTTPS_PROXY="https://USERNAME:PASSWORD@[your.proxy.server]:[port]"
<h1>Centos</h1>
<pre>
dracut --force --regenerate-all
/etc/default/grub
grub2-mkconfig -o /boot/grub2/grub.cfg
grub-mkconfig -o /boot/grub/grub.cfg

</pre>

<pre>
INDEX=$(date "+%j%%15" | bc)

vimdiff $HOME/.local/share/kxmlgui5/konsole/konsoleui.rc ./.local/share/kxmlgui5/konsole/konsoleui.rc 
</pre>

<pre>
add-apt-repository ppa:yannubuntu/boot-repair
apt-get update
apt-get install -y boot-repair && boot-repair
mount -t proc none /mnt/proc
mount -o bind /dev /mnt/dev
mount -t sysfs /sys /mnt/sys
chroot /mnt
grub-install /dev/sda
grub2-mkconfig -o /boot/grub2/grub.cfg

</pre>

<h1>NetworkManager</h1>
<pre>
/etc/NetworkManager/NetworkManager.conf
[main]
plugins=keyfile
dns=dnsmasq

nmtui
</pre>

<h1>PS</h1>
<pre>
powershell
gwmi win32_operatingsystem|select Version
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux
Invoke-WebRequest -Uri https://aka.ms/wsl-ubuntu-1804 -OutFile ~/Ubuntu.zip -UseBasicParsing
Expand-Archive ~/Ubuntu.zip C:\Distros\Ubuntu
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
Enable-WindowsOptionalFeature -Online -FeatureName Containers -All

Register-PSRepository -Default

Find-PackageProvider ContainerImage -Verbose
Find-Module ContainerImage -Verbose
Get-PackageProvider -ListAvailable

Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All

Register-PSRepository -Name "PSGallery" –SourceLocation "https://www.powershellgallery.com/api/v2/" -InstallationPolicy Trusted

</pre>
shell request failed on channel 0
/etc/security/limits.d/20-nproc.conf

<h1>tmp</h1>
<pre>
sudo cp -v /usr/share/systemd/tmp.mount /etc/systemd/system/ 
sudo systemctl enable tmp.mount
</pre>

<h1>dd</h1>
<pre>
dd if=/dev/mapper/vg_thin01-volA of=/dev/mapper/vg_thin02-volA conv=sparse status=progress
</pre>

<pre>
lvconvert -m1 /dev/centos/docker --mirrorlog core --type mirror --stripes 2 /dev/sdc /dev/sdd
lvs --all --segments -o +devices
lvconvert -m0 /dev/centos/docker /dev/sda


btrfs check --clear-space-cache v1 lvol
btrfstune -u lvol


</pre>
<h1>fstab</h1>
<pre>
</pre>
<pre>

SELECT * FROM pg_settings WHERE name = 'temp_file_limit';
SELECT name,setting,unit FROM pg_settings WHERE name = 'temp_file_limit';
SELECT temp_files AS "Temporary files", temp_bytes AS "Size of temporary files" FROM pg_stat_database db;

/dev/sdf1
xfs_admin -U `uuidgen` /dev/sdf1
tune2fs -U random /dev/sdb1 


Get-LocalUser -Name planeta | Select-Object *
Set-LocalUser -Name planeta -PasswordNeverExpires:$true
Get-LocalUser | where { $_.passwordNeverExpires -eq "true" -and $_.PasswordNeverExpires -eq "true" }


</pre>
</body>
</html>
