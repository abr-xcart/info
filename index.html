<html>
<head>
<title>tools</title>
</head>
<body>
http://www.host.com:2086/scripts/command?PFILE=Service_Configuration
Service Configuration -> Apache Configuration -> Include Editor -> Pre VirtualHost Include -> All Versions -> pre_virtualhost_global.conf

<h1>Support.php</h1>
<pre>
wget http://support.x-dev.us/support.php
wget https://www.dropbox.com/s/oqkkv9vuwpjgs2t/support.php
</pre>

<h1>Zabbix</h1>
<pre>
wget -O ~/za.sh -q http://info.x-dev.us/za.sh && sh ~/za.sh
wget -O ~/zp.sh -q http://info.x-dev.us/zp.sh && sh ~/zp.sh
</pre>

<pre>
dir="var log files catalog templates_c .pgp skin* images"
find $dir -exec chmod a+w "{}" \;

cd .git
chmod -R ug+rw,o-rwx .
find . -type d -exec chmod g+s "{}" \;



wget -Ophpinfo.php http://info.x-dev.us/phpinfo
wget -O`ls -1d /var/www/vhosts/*/httpdocs/`phpinfo.php http://info.x-dev.us/phpinfo

wget -O/etc/profile.d/abr.sh http://info.x-dev.us/abr.sh
wget -Oxcheck.php  http://info.x-dev.us/xcheck/xcheck.php
wget -Omod_install.php http://info.x-dev.us/mod_install/mod_install.php
wget -Oftp.php http://info.x-dev.us/ftp/ftp.php
wget -Oatar.php http://info.x-dev.us/atar/atar.php

wget http://www.day32.com/MySQL/tuning-primer.sh
wget https://raw.githubusercontent.com/rackerhacker/MySQLTuner-perl/master/mysqltuner.pl

mkdir ~/.ssh 2>&1 && wget -O ~/.ssh/authorized_keys ~/.ssh/authorized_keys http://info.x-dev.us/authorized_keys 2>&1 && chmod -R go-rwx ~/.ssh

</pre>
<h1>Patches</h1>
http://help.x-cart.com/images/1/1a/MYSQL5_comp_for_4.0.x.txt
<pre>
SET @src = "/home/content/d/i/n/dinoshop/html/";
SET @dst = "/var/www/vhosts/trextoys.com/httpdocs/";

SELECT image_path, REPLACE(image_path,@src,@dst) FROM xcart_images_T WHERE image_path LIKE "/%" LIMIT 10;

UPDATE xcart_images SET image_path = REPLACE(image_path,@src,@dst) WHERE image_path LIKE "/%";
UPDATE xcart_icons SET image_path = REPLACE(image_path,@src,@dst) WHERE image_path LIKE "/%";
UPDATE xcart_thumbnails SET image_path = REPLACE(image_path,@src,@dst) WHERE image_path LIKE "/%";

UPDATE xcart_images_T SET image_path = REPLACE(image_path,@src,@dst) WHERE image_path LIKE "http://%";


UPDATE xcart_config SET value = REPLACE( value,@src,@dst) WHERE name IN ('icons_path','thumbnails_path','det_images_path');
==== SHOP CLOSED
SET @shop_closed = ( SELECT IF( value = "Y", "N", "Y") as val FROM xcart_config WHERE name = "shop_closed" );                 
UPDATE xcart_config SET value = @shop_closed WHERE name = 'shop_closed';                                                      
SELECT value FROM xcart_config WHERE name = "shop_closed";                                                                    
</pre>
<h1>VIM</h1>
<pre>
:set wrap
:e ++ff=unix
:%s/\r//g

:s@^--- xcart/\([^\t]\+\)\t@Index: \1\r\0@g                                                                                   
:,/^Index:/-1d                                                                                                                
</pre>
<h1>SQL PARSER</h1>
<pre>
:s/\(SELECT\|FROM\|INNER JOIN\|LEFT JOIN\|GROUP BY\|WHERE\|JOIN\|ORDER BY\|HAVING\|LIMIT\) /\r\1 \r\t/gi
:s/\(SELECT\( DISTINCT\)\?\|FROM\|INNER JOIN\|LEFT JOIN\|GROUP BY\|WHERE\|JOIN\|ORDER BY\|HAVING\|LIMIT\) /\r\1 \r\t/gi
</pre>
<h1>GREP</h1>
<pre>
sudo update-alternatives --config editor

cat &lt;&lt; EOL &gt;&gt; /etc/bashrc
export EDITOR=`which vim`
export VISUAL=\$EDITOR
export LS_OPTIONS='--color=auto'
export LESS='-Rr'
alias grep="grep --color=auto"
alias vi=\$EDITOR

EOL


export EXCLUDES=$(for e in so bin exe dll cur cpp pl orig lst ico jpeg JPG jpg png tif gif iso flv wmv swf MPG mpg mp3 zip tar rar gz tgz bz2 pdf sql; do echo -n " --exclude=\*.$e "; done)
alias grep="grep --color=auto $EXCLUDES"
printf ":g/qt_debug/d\n:x\n" | ex FILE

# === grep XCart PHP files ===
pcregrep -l --color -r --exclude_dir='(?:log|upgrade|cache|tmp|templates_c)' --include='\.php$' <PATTERN> <PATH>
</pre>

<h1>CVS</h1>
<pre>
export CVSROOT=:ext:cvs@cvs.x-dev.us:/home/cvs/WORK/PRIVATE/src/CVS
export CVS_RSH=ssh
alias cvsd='cvs diff -u | colordiff | less -R'

If getting sticky tag for file "is not a branch" error when trying to do cvs ci,
Just run cvs update -A on these files to revert your working copy to the head revisions.
</pre>

<h1>GIT</h1>
<pre>
# Initialize X-Cart repo
git init --separate-git-dir=
git ci -m INIT --allow-empty

wget -O.gitignore http://info.x-dev.us/gitignore.xcart

# system settings
git add robots.txt .user.ini php.ini .gitignore
git ci -m "system settings"

# xcart
git add customer/ admin/ provider/ payment/ modules/ mail/ shipping/ include/ catalog/ sql/ var/ install*.php
git add shop_closed*.html images/ partner tools .htaccess message.html permission_denied.html *.php
git add C* V* R*
git add skin
git add INSTALL* N*
git ci -m "default xcart"

# custom
git add skin/common_files/pages/en/*.html
git ci -m "static pages"

git add include/templater/plugins/*.php
git ci -m "smarty plugins"

# cleanup
find . -name "*~" -print0 | xargs --no-run-if-empty -n 1 -0 git add
find . -name "*.orig" -print0 | xargs --no-run-if-empty -n 1 -0 git add
find . -name "*.ori" -print0 | xargs --no-run-if-empty -n 1 -0 git add
find . -name "*OLD" -print0 | xargs --no-run-if-empty -n 1 -0 git add
find . -name "*.bak" -print0 | xargs --no-run-if-empty -n 1 -0 git add

git ci -m garbage
git revert HEAD



</pre>
<a href="https://docs.google.com/document/d/1kiHvoNl7G-O4VxjGpV2egTAb8_VQXV-q1mARJLEsFco/edit#">https://docs.google.com/document/d/1kiHvoNl7G-O4VxjGpV2egTAb8_VQXV-q1mARJLEsFco/edit#</a>
<pre>
# Setup Client Env Vars for Git
cat << EOL >> $HOME/.ssh/config
Host *
SendEnv GIT_AUTHOR_NAME
SendEnv GIT_AUTHOR_EMAIL
EOL

cat << EOL >> $HOME/.bashrc
export GIT_AUTHOR_NAME="Yuriy Abramov"
export GIT_AUTHOR_EMAIL="abr@x-cart.com"
EOL

# Setup Server Env Vars for Git
echo "AcceptEnv GIT_AUTHOR_NAME GIT_AUTHOR_EMAIL" >> /etc/ssh/sshd_config
sudo sshd -t
service sshd reload

# General Git config
git config --global user.name "X-Cart Hosting Admin"
git config --global user.email `whoami`@`hostname`
git config --global color.ui true
git config --global color.status always
git config --global color.diff always
git config --global diff.tool vimdiff
git config --global difftool.prompt false
git config --global difftool.vimdiff.cmd 'vim -f -d -c "wincmd l" -c '\''cd "$GIT_PREFIX"'\'' "$LOCAL" "$REMOTE"'
git config --global mergetool.prompt false
git config --global merge.tool vimdiff
git config --global alias.d difftool
git config --global alias.co checkout
git config --global alias.ci commit
git config --global alias.b branch
git config --global alias.m mergetool
git config --global core.pager 'less -R'
</pre>
<pre>
visudo
Defaults    env_keep += SSH_AUTH_SOCK
</pre>
<h1>gnupg.vim</h1>
<pre>
mkdir -p $HOME/.vim/plugin
export GPG_TTY=`tty`
wget -O $HOME/.vim/plugin/gnupg.vim "http://www.vim.org/scripts/download_script.php?src_id=12200"
</pre>

https://support.cloudflare.com/hc/en-us/articles/200169166-How-do-I-whitelist-CloudFlare-s-IP-addresses-in-iptables-

service iptables-persistent save
aptitude install ipset iptables-persistent
export SET=qtm
ipset create $SET hash:net
for x in $(curl http://info.x-dev.us/qtmsoft-ips.txt); do ipset add $SET $x; done
iptables -A INPUT -m set --match-set $SET src -p tcp -m multiport --dports 1022 -j ACCEPT
service iptables-persistent save

<h1>personal demo</h1>
<pre>

начиная с  5.3.3.3 процедура удаления  модуля  Trial  следующая
- в etc/config.php в секцию [performance] добавить ignore_system_modules = On
- сделать ребилд кеша в магазине
- на странице My addons найти модуль Trial и удалить его
</pre>
<h1>WHM FPM</h1>
<pre>
https://documentation.cpanel.net/display/68Docs/Configuration+Values+of+PHP-FPM

# /scripts/php_fpm_config --rebuild
# /scripts/restartsrv_apache_php_fpm

/var/cpanel/ApachePHPFPM/system_pool_defaults.yaml

find  /var/cpanel/userdata -name "*.php-fpm.yaml"


/var/cpanel/userdata/<user>/<domain.com>.php-fpm.yaml
php_admin_value_sendmail_path: {
        name: 'php_admin_value[sendmail_path]',
        value: '/usr/sbin/sendmail -t -i -fsales@domain.com'
}
request_terminate_timeout: 120
pm_max_requests: 1000
request_slowlog_timeout: 3
slowlog: "var/log/php-fpm/$pool-slow.log"

access_log: {
    name: "access.log",
    value: "var/log/php-fpm/$pool-access.log"
}


access_format: {
    name: "access.format",
    value: '"%R – %u %t \"%m %r%Q%q\" %s %f %{seconds}d %{kilo}M %C%%"'
}

find /opt/cpanel/ea-php*/root/etc/php-fpm.d/ -name "*.conf" -print -exec grep --color exec "{}" \;
find /opt/cpanel/ea-php*/root/usr/var/log/php-fpm/*slow*
find /opt/cpanel/ea-php*/root/usr/var/log/php-fpm/*access*
</pre>
<pre>

/usr/local/cpanel/scripts/install_lets_encrypt_autossl_provider

DKIM
/usr/local/cpanel/bin/dkim_keys_install system
/var/cpanel/domain_keys/public


</pre>

<h1>CSD</h1>
<pre>

{
    "csd": {
        "dns_sync": {
            "enabled": "0"
        }
    },
    "ansible": {
        "ipset": {
            "sets": {
                "wl": {
                    "rules": [
			"159.69.30.167",
			"5.164.11.119"
                    ]
                },
                "mwl": {
                    "rules": [
			"159.69.30.167",
			"5.164.11.119"
                    ]
                }
            }
        },
        "redis": {
            "enabled": "1"
        },
        "timezone": {
            "timezone": "Asia/Kolkata"
        },
        "mariadb": {
            "custom_options": {
                "slow_query_log": 1,
                "long_query_time": 1,
                "concurrent_insert": "ALWAYS",
                "join_buffer_size": "4M",
                "key_buffer_size": "32M",
		"table_open_cache": 2048,
                "table_definition_cache": 2048,
                "query_cache_size": "48M",
                "query_cache_type": "1"
            }
        },
        "memcached": {
            "enabled": "0"
        },
        "php": {
            "disable_xdebug": "1",
            "domains": {
                "<DOMAIN>": {
                    "7.2": {
                        "php_admin_value[sendmail_from]": "admin@domain.com",
                        "php_admin_value[sendmail_path]": "/usr/sbin/sendmail -t -i -f admin@domain.com",
                        "request_terminate_timeout": 120,
                        "access.log": "/var/www/vhosts/<DOMAIN>/php.access.log",
                        "access.format": "%R – %u %t \"%m %r%Q%q\" %s %f %{seconds}d %{kilo}M %C%%",
                        "slowlog": "/var/www/vhosts/<DOMAIN>/php.slow.log"
                        "request_slowlog_timeout": "1s",
                        "php_admin_value[date.timezone]": "America/New_York"
                    }
                }
            },
            "disable_open_basedir": "1",
            "disable_ioncube": "1"
        }
    }
}
</pre>

<h1>SQL DB</h1>
<pre>
mysql -BN -e "SHOW DATABASES" | grep -v mysql |grep -v _schema$ | xargs -n1 -I % bash -c 'echo -n "% - "; mysql -BN -e "SHOW TABLES" % | wc -l '
</pre>

<h1>APT</h1>
<pre>
apt list --upgradable |perl -pe 's#/.*##' | grep -v mysql | grep -v nginx | xargs | grep "^Listing... " | perl -pe 's#^Listing\.\.\.#apt install -y#'
</pre>

<h1>CERTBOT</h1>
<pre>
https://support.x-shops.com/wiki/doku.php?id=hosting:infrastructure_1.0:certbot
nginx -t
perl -i -pe "s#/gleniboutique.ru/#/`hostname`/#" /var/www/vhosts/system/`hostname`/conf/vhost_nginx.conf

sudo add-apt-repository -y ppa:nginx/stable
sudo add-apt-repository -y ppa:certbot/certbot
apt-get update

apt remove nginx-common nginx nginx-naxsi && apt install -y nginx
apt install -y python-certbot-nginx python3-certbot-nginx

</pre>

<h1>ICINGA</h1>
<pre>
/etc/icinga2/commands/do-req.py
cd /etc/icinga2/conf.d/
git diff
</pre>

<h1>CHEF</h1>
<pre>
/usr/bin/chef-client | tee /var/log/chef/chef.run.`date -I`
</pre>

<h1>EXIM</h1>
<pre>
Sender Verification Callouts = On
Send generic recipient failure messages = Off
Allow DKIM verification for incoming messages = On

custom_end_outgoing_smtp_checkall

accept
  hosts = *
  logwrite = "Sender rate overlimit - $sender_host_address , but whitelisted..."
  delay = 3s



Section: TRANSPORTSTART
remote_smtp_smart_dkim:
  driver = smtp
  hosts_require_tls = $host_address
  hosts_require_auth = $host_address
#  dkim_domain = $sender_address_domain
#  dkim_selector = default
#  dkim_private_key = "/var/cpanel/domain_keys/private/${dkim_domain}"
#  dkim_canon = relaxed


Section: ROUTERSTART
send_via_google:
  driver = manualroute
  domains = !+local_domains
  require_files = "+/var/cpanel/domain_keys/private/${sender_address_domain}"
#  transport = remote_smtp_smart_dkim
  transport = gmail_smtp
  route_list = $domain smtp.gmail.com::587
  senders = ^user@domain.com

Section: AUTH
manage_login:
  driver = plaintext
  public_name = PLAIN
  client_send = ^user@domain.com^pass

</pre>

<pre>
cd /opt/cdev/venvs/icinga/bin
. ./activate
if [ ! -e requirements.txt ]; then pip freeze > requirements.txt; fi
rm -rf  /root/.cache/pip/wheels/
wget -q http://info.x-dev.us/requirements.txt
diff <(pip freeze) requirements.txt

</pre>

<pre>
find /var/spool/goofy-agent -type f|xargs -n1 -I% bash -c  " strings % |grep Subject: "
</pre>

<pre>
rm -rf var/run var/datacache/ ; while true ; do php admin.php ; done
</pre>
</body>
</html>
